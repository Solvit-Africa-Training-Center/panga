{% extends './base.html' %}

{% block title %}{{ title }} - GUKODESHA{% endblock %}

{% block extra_css %}
<style>
    /* Force dark mode styling for select dropdowns */
    select {
        color-scheme: dark;
    }
    
    select option {
        background-color: #122017 !important;
        color: white !important;
        padding: 10px !important;
    }
    
    select option:checked,
    select option:hover {
        background-color: #1c2620 !important;
        color: #38e07b !important;
    }
    
    /* Firefox specific */
    @-moz-document url-prefix() {
        select option {
            background-color: #122017;
            color: white;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="py-8 px-4 md:px-10 max-w-[1440px] mx-auto">
    <div class="max-w-4xl mx-auto">
        <div class="bg-surface-dark rounded-xl overflow-hidden border border-border-dark shadow-2xl">
            <!-- Header -->
            <div class="bg-gradient-to-r from-primary/20 to-surface-dark border-b border-border-dark px-6 py-5">
                <h3 class="text-white text-2xl font-bold flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary text-3xl">add_home</span>
                    {{ title }}
                </h3>
                <p class="text-text-secondary text-sm mt-1">Fill in the details below to list your property</p>
            </div>
            
            <!-- Form Body -->
            <div class="p-6 md:p-8">
                <form method="post" enctype="multipart/form-data" id="houseForm">
                    {% csrf_token %}
                    
                    <!-- Basic Information -->
                    <div class="mb-8">
                        <h5 class="text-white text-lg font-bold mb-4 pb-2 border-b border-border-dark flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">info</span>
                            Basic Information
                        </h5>
                        
                        <div class="mb-5">
                            <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-text-secondary mb-2">
                                House Name
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <p class="text-red-400 text-sm mt-1 flex items-center gap-1">
                                    <span class="material-symbols-outlined text-xs">error</span>
                                    {{ form.name.errors.0 }}
                                </p>
                            {% endif %}
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                            <div>
                                <label for="{{ form.type.id_for_label }}" class="block text-sm font-medium text-text-secondary mb-2">
                                    House Type <span class="text-red-400">*</span>
                                </label>
                                {{ form.type }}
                                {% if form.type.errors %}
                                    <p class="text-red-400 text-sm mt-1 flex items-center gap-1">
                                        <span class="material-symbols-outlined text-xs">error</span>
                                        {{ form.type.errors.0 }}
                                    </p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-text-secondary mb-2">
                                    Status <span class="text-red-400">*</span>
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <p class="text-red-400 text-sm mt-1 flex items-center gap-1">
                                        <span class="material-symbols-outlined text-xs">error</span>
                                        {{ form.status.errors.0 }}
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-5">
                            <label for="{{ form.monthly_rent.id_for_label }}" class="block text-sm font-medium text-text-secondary mb-2">
                                Monthly Rent (RWF) <span class="text-red-400">*</span>
                            </label>
                            {{ form.monthly_rent }}
                            {% if form.monthly_rent.errors %}
                                <p class="text-red-400 text-sm mt-1 flex items-center gap-1">
                                    <span class="material-symbols-outlined text-xs">error</span>
                                    {{ form.monthly_rent.errors.0 }}
                                </p>
                            {% endif %}
                        </div>
                        
                        <div class="mb-5">
                            <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-text-secondary mb-2">
                                Description <span class="text-red-400">*</span>
                            </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <p class="text-red-400 text-sm mt-1 flex items-center gap-1">
                                    <span class="material-symbols-outlined text-xs">error</span>
                                    {{ form.description.errors.0 }}
                                </p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Location Information -->
                    <div class="mb-8">
                        <h5 class="text-white text-lg font-bold mb-4 pb-2 border-b border-border-dark flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">location_on</span>
                            Location
                        </h5>
                        
                        <div class="mb-5">
                            <label for="{{ form.location.id_for_label }}" class="block text-sm font-medium text-text-secondary mb-2">
                                Village <span class="text-red-400">*</span>
                            </label>
                            {{ form.location }}
                            <p class="text-text-secondary text-xs mt-1">Select the village where the house is located</p>
                            {% if form.location.errors %}
                                <p class="text-red-400 text-sm mt-1 flex items-center gap-1">
                                    <span class="material-symbols-outlined text-xs">error</span>
                                    {{ form.location.errors.0 }}
                                </p>
                            {% endif %}
                        </div>
                        
                        <div class="mb-5">
                            <label for="{{ form.neighborhood.id_for_label }}" class="block text-sm font-medium text-text-secondary mb-2">
                                Neighborhood
                            </label>
                            {{ form.neighborhood }}
                            {% if form.neighborhood.errors %}
                                <p class="text-red-400 text-sm mt-1 flex items-center gap-1">
                                    <span class="material-symbols-outlined text-xs">error</span>
                                    {{ form.neighborhood.errors.0 }}
                                </p>
                            {% endif %}
                        </div>
                        
                        <div class="mb-5">
                            <label for="{{ form.street_address.id_for_label }}" class="block text-sm font-medium text-text-secondary mb-2">
                                Street Address
                            </label>
                            {{ form.street_address }}
                            {% if form.street_address.errors %}
                                <p class="text-red-400 text-sm mt-1 flex items-center gap-1">
                                    <span class="material-symbols-outlined text-xs">error</span>
                                    {{ form.street_address.errors.0 }}
                                </p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Images -->
                    <div class="mb-8">
                        <h5 class="text-white text-lg font-bold mb-4 pb-2 border-b border-border-dark flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">photo_camera</span>
                            Images
                        </h5>
                        
                        <div class="mb-5">
                            <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-text-secondary mb-2">
                                Main Image
                            </label>
                            {{ form.image }}
                            {% if form.image.errors %}
                                <p class="text-red-400 text-sm mt-1 flex items-center gap-1">
                                    <span class="material-symbols-outlined text-xs">error</span>
                                    {{ form.image.errors.0 }}
                                </p>
                            {% endif %}
                            {% if house.image %}
                            <div class="mt-3">
                                <img src="{{ house.image.url }}" alt="Current image" class="rounded-lg border border-border-dark max-w-xs shadow-lg">
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Additional Images Formset -->
                        <div id="image-formset" class="space-y-4">
                            <h6 class="text-text-secondary font-medium mb-3 flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">collections</span>
                                Additional Images
                            </h6>
                            {{ image_formset.management_form }}
                            
                            {% for form in image_formset %}
                            <div class="border border-border-dark rounded-lg p-4 bg-background-dark/50 hover:border-primary/30 transition-colors">
                                {{ form.id }}
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                                    <div class="md:col-span-7">
                                        <label class="block text-sm font-medium text-text-secondary mb-2">Image</label>
                                        {{ form.image }}
                                    </div>
                                    <div class="md:col-span-3">
                                        <label class="block text-sm font-medium text-text-secondary mb-2">Main Image</label>
                                        <div class="flex items-center h-10">
                                            {{ form.is_main }}
                                            <span class="ml-2 text-xs text-text-secondary">Set as main</span>
                                        </div>
                                    </div>
                                    <div class="md:col-span-2">
                                        {% if form.instance.pk %}
                                        <label class="block text-sm font-medium text-text-secondary mb-2">Delete</label>
                                        <div class="flex items-center h-10">
                                            {{ form.DELETE }}
                                            <span class="ml-2 text-xs text-red-400">Remove</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if form.instance.image %}
                                <div class="mt-3">
                                    <img src="{{ form.instance.image.url }}" alt="Image" class="rounded-lg border border-border-dark max-w-xs shadow-lg">
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Active Status -->
                    <div class="mb-6 p-4 bg-background-dark/50 rounded-lg border border-border-dark">
                        <div class="flex items-start gap-3">
                            {{ form.is_active }}
                            <div>
                                <label for="{{ form.is_active.id_for_label }}" class="text-sm font-medium text-white cursor-pointer">
                                    Active Listing
                                </label>
                                <p class="text-xs text-text-secondary mt-1">Make this listing visible to the public</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Buttons -->
                    <div class="flex flex-col sm:flex-row gap-3 pt-6 border-t border-border-dark">
                        <button type="submit" class="flex items-center justify-center gap-2 bg-primary hover:bg-primary-hover text-background-dark px-6 py-3 rounded-lg transition-all font-bold shadow-[0_0_15px_rgba(56,224,123,0.3)] hover:shadow-[0_0_20px_rgba(56,224,123,0.4)]">
                            <span class="material-symbols-outlined">check_circle</span>
                            Save House
                        </button>
                        <a href="{% url 'properties:house_list' %}" class="flex items-center justify-center gap-2 bg-surface-dark border border-border-dark hover:bg-border-dark text-white px-6 py-3 rounded-lg transition-all font-bold">
                            <span class="material-symbols-outlined">cancel</span>
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Form validation
    document.getElementById('houseForm').addEventListener('submit', function(e) {
        let isValid = true;
        const requiredFields = document.querySelectorAll('[required]');
        
        requiredFields.forEach(field => {
            if (!field.value) {
                isValid = false;
                field.classList.add('border-red-400', 'ring-2', 'ring-red-400/20');
                field.classList.remove('border-border-dark');
            } else {
                field.classList.remove('border-red-400', 'ring-2', 'ring-red-400/20');
                field.classList.add('border-border-dark');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            // Show error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500/20 border border-red-500/50 text-red-400 px-4 py-3 rounded-lg backdrop-blur-sm z-50 flex items-center gap-2';
            errorDiv.innerHTML = '<span class="material-symbols-outlined text-sm">error</span>Please fill in all required fields.';
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 3000);
        }
    });
</script>
{% endblock %}